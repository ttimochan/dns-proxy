# DNS Proxy

ä¸€ä¸ªé«˜æ€§èƒ½ã€æ¨¡å—åŒ–çš„ DNS ä»£ç†æœåŠ¡å™¨ï¼Œæ”¯æŒ DoQã€DoHã€DoTã€DoH3 åè®®ï¼Œèƒ½å¤Ÿä» SNIï¼ˆServer Name Indicationï¼‰ä¸­æå–å‰ç¼€ä¿¡æ¯å¹¶é‡å†™åè½¬å‘åˆ°ä¸Šæ¸¸æœåŠ¡å™¨ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… **DoT (DNS over TLS)** - TCP 853 ç«¯å£
- âœ… **DoH (DNS over HTTPS)** - TCP 443 ç«¯å£
- âœ… **DoQ (DNS over QUIC)** - UDP 853 ç«¯å£
- âœ… **DoH3 (DNS over HTTP/3)** - UDP 443 ç«¯å£
- ğŸ”’ **åŠ¨æ€ TLS è¯ä¹¦é€‰æ‹©** - åŸºäº SNI è‡ªåŠ¨é€‰æ‹©è¯ä¹¦
- ğŸ¯ **å¤šåŸŸåæ”¯æŒ** - æ”¯æŒå¤šä¸ªåŸºå‡†åŸŸåçš„å‰ç¼€æå–å’Œé‡å†™
- ğŸš€ **é«˜æ€§èƒ½** - åŸºäº Tokio å¼‚æ­¥è¿è¡Œæ—¶ï¼Œæ”¯æŒé«˜å¹¶å‘
- âš¡ **é›¶æ‹·è´ä¼˜åŒ–** - å‡å°‘ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ï¼Œæå‡æ€§èƒ½
- ğŸ—ï¸ **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤

## å·¥ä½œåŸç†

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ DNS Query (SNI: www.example.org)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DNS Proxy Server               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Protocol Readers             â”‚  â”‚
â”‚  â”‚  - DoH (TCP 443)              â”‚  â”‚
â”‚  â”‚  - DoT (TCP 853)              â”‚  â”‚
â”‚  â”‚  - DoQ (UDP 853)              â”‚  â”‚
â”‚  â”‚  - DoH3 (UDP 443)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SNI Extractor                 â”‚  â”‚
â”‚  â”‚  - DoH: Host header            â”‚  â”‚
â”‚  â”‚  - DoT: TLS handshake          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SNI Rewriter                  â”‚  â”‚
â”‚  â”‚  www.example.org                â”‚  â”‚
â”‚  â”‚    â†’ extract "www"              â”‚  â”‚
â”‚  â”‚    â†’ build "www.example.cn"    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Certificate Resolver           â”‚  â”‚
â”‚  â”‚  - Select cert by SNI           â”‚  â”‚
â”‚  â”‚  - Cache certificates           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Forward to upstream
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Upstream DNS Server                â”‚
â”‚   (www.example.cn)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹è¯¦è§£

#### 1. å¯åŠ¨é˜¶æ®µ

```
main.rs
  â””â”€> åŠ è½½é…ç½® (config.toml æˆ–é»˜è®¤å€¼)
      â””â”€> åˆ›å»º App å®ä¾‹
          â””â”€> åˆ›å»º SNI Rewriter
              â””â”€> å¯åŠ¨å„ä¸ªåè®®çš„æœåŠ¡å™¨ï¼ˆå¹¶è¡Œï¼‰
                  â”œâ”€> DoT Server (TCP 853)
                  â”œâ”€> DoH Server (TCP 443)
                  â”œâ”€> DoQ Server (UDP 853)
                  â””â”€> DoH3 Server (UDP 443)
```

#### 2. è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆä»¥ DoH ä¸ºä¾‹ï¼‰

```
1. å®¢æˆ·ç«¯è¯·æ±‚
   â””â”€> GET/POST https://www.example.org/dns-query
       â””â”€> Host: www.example.org

2. DoH Server æ¥æ”¶
   â””â”€> æå– Host header â†’ SNI: "www.example.org"
       â””â”€> è°ƒç”¨ SNI Rewriter

3. SNI Rewriter å¤„ç†
   â””â”€> åŒ¹é…åŸºå‡†åŸŸå: ["example.com", "example.org"]
       â””â”€> æ‰¾åˆ°åŒ¹é…: "example.org"
           â””â”€> æå–å‰ç¼€: "www"
               â””â”€> æ„å»ºç›®æ ‡: "www.example.cn"
                   â””â”€> ç¼“å­˜æ˜ å°„å…³ç³»

4. è½¬å‘è¯·æ±‚
   â””â”€> æ„å»ºä¸Šæ¸¸ URI: https://www.example.cn/dns-query
       â””â”€> å¤åˆ¶è¯·æ±‚å¤´ï¼ˆæ›´æ–° Hostï¼‰
           â””â”€> è½¬å‘åˆ°ä¸Šæ¸¸æœåŠ¡å™¨
               â””â”€> è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```

#### 3. SNI é‡å†™é€»è¾‘

**å‰ç¼€æå–ç®—æ³•ï¼š**

```rust
è¾“å…¥: SNI = "www.example.org"
é…ç½®: base_domains = ["example.com", "example.org"]
      target_suffix = ".example.cn"

æ­¥éª¤:
1. éå† base_domains
2. æ£€æŸ¥ SNI æ˜¯å¦ä»¥ base_domain ç»“å°¾
   - "www.example.org".ends_with("example.org") âœ“
3. æå–å‰©ä½™éƒ¨åˆ†
   - rest = "www.example.org".strip_suffix("example.org") = "www."
4. éªŒè¯æ ¼å¼ï¼ˆå¿…é¡»ä»¥ '.' ç»“å°¾ä¸”ä¸ä¸ºç©ºï¼‰
   - rest.ends_with('.') && !rest.is_empty() âœ“
5. æå–å‰ç¼€
   - prefix = "www.".strip_suffix('.') = "www"
6. æ„å»ºç›®æ ‡ä¸»æœºå
   - target = prefix + target_suffix = "www.example.cn"
```

**ç¤ºä¾‹ï¼š**

| è¾“å…¥ SNI          | åŒ¹é…åŸºå‡†åŸŸå  | æå–å‰ç¼€ | ç›®æ ‡ä¸»æœºå                 |
| ----------------- | ------------- | -------- | -------------------------- |
| `www.example.org` | `example.org` | `www`    | `www.example.cn`           |
| `api.example.com` | `example.com` | `api`    | `api.example.cn`           |
| `sub.example.org` | `example.org` | `sub`    | `sub.example.cn`           |
| `example.org`     | -             | -        | ä¸åŒ¹é…ï¼ˆæ— å‰ç¼€ï¼‰           |
| `www.other.com`   | -             | -        | ä¸åŒ¹é…ï¼ˆä¸åœ¨åŸºå‡†åŸŸååˆ—è¡¨ï¼‰ |

#### 4. TLS è¯ä¹¦é€‰æ‹©

```
TLS æ¡æ‰‹è¯·æ±‚ (SNI: www.example.org)
  â””â”€> CertificateResolver.resolve()
      â”œâ”€> æ£€æŸ¥ç¼“å­˜
      â”‚   â””â”€> å‘½ä¸­ â†’ è¿”å›ç¼“å­˜çš„è¯ä¹¦
      â””â”€> æœªå‘½ä¸­
          â””â”€> æŸ¥æ‰¾è¯ä¹¦é…ç½®
              â”œâ”€> æŸ¥æ‰¾ tls.certs["www.example.org"] â†’ æœªæ‰¾åˆ°
              â”œâ”€> æŸ¥æ‰¾ tls.certs["example.org"] â†’ æœªæ‰¾åˆ°
              â””â”€> å›é€€åˆ° tls.default â†’ æ‰¾åˆ°
                  â””â”€> åŠ è½½è¯ä¹¦æ–‡ä»¶
                      â””â”€> ç¼“å­˜å¹¶è¿”å›
```

**è¯ä¹¦é€‰æ‹©ä¼˜å…ˆçº§ï¼š**

1. **ç²¾ç¡®åŒ¹é…** - `tls.certs[SNI]`ï¼ˆä¾‹å¦‚ï¼š`tls.certs["www.example.org"]`ï¼‰
2. **åŸºå‡†åŸŸååŒ¹é…** - `tls.certs[base_domain]`ï¼ˆä¾‹å¦‚ï¼š`tls.certs["example.org"]`ï¼‰
3. **é»˜è®¤è¯ä¹¦** - `tls.default`ï¼ˆå¦‚æœé…ç½®ï¼‰
4. **é”™è¯¯** - å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¯ä¹¦é…ç½®

#### 5. å„åè®®å®ç°ç»†èŠ‚

**DoH (DNS over HTTPS)**

- ç›‘å¬ç«¯å£ï¼šTCP 443
- SNI æå–ï¼šä» HTTP `Host` header
- è¯·æ±‚è½¬å‘ï¼šä½¿ç”¨ Hyper HTTP å®¢æˆ·ç«¯
- æ”¯æŒæ–¹æ³•ï¼šGETã€POST

**DoT (DNS over TLS)**

- ç›‘å¬ç«¯å£ï¼šTCP 853
- SNI æå–ï¼šä» TLS handshakeï¼ˆé€šè¿‡ `ClientHello`ï¼‰
- è¯·æ±‚è½¬å‘ï¼šTLS éš§é“è½¬å‘
- è¯ä¹¦é€‰æ‹©ï¼šåŠ¨æ€è¯ä¹¦è§£æå™¨

**DoQ (DNS over QUIC)**

- ç›‘å¬ç«¯å£ï¼šUDP 853
- SNI æå–ï¼šä» QUIC connection
- è¯·æ±‚è½¬å‘ï¼šQUIC åŒå‘æµè½¬å‘
- å®ç°ï¼šä½¿ç”¨ quinn 0.11 å’Œæ¨¡å—åŒ–çš„ QUIC å®¢æˆ·ç«¯

**DoH3 (DNS over HTTP/3)**

- ç›‘å¬ç«¯å£ï¼šUDP 443
- SNI æå–ï¼šä» HTTP Host header
- è¯·æ±‚è½¬å‘ï¼šHTTP/3 è¯·æ±‚è½¬å‘ï¼ˆä½¿ç”¨ h3 å’Œ h3-quinnï¼‰
- å®ç°ï¼šå®Œæ•´çš„ HTTP/3 æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ”¯æŒ

## é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ main.rs              # ç¨‹åºå…¥å£ï¼Œåˆå§‹åŒ–æ—¥å¿—å’Œé…ç½®
â”œâ”€â”€ app.rs               # åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¯åŠ¨å„åè®®æœåŠ¡å™¨
â”œâ”€â”€ config.rs            # é…ç½®ç»“æ„å®šä¹‰å’ŒåŠ è½½é€»è¾‘
â”œâ”€â”€ sni.rs               # SNI é‡å†™å™¨ trait å®šä¹‰
â”œâ”€â”€ rewrite.rs           # Rewriter å·¥å‚å‡½æ•°
â”œâ”€â”€ tls_utils.rs         # TLS è¯ä¹¦åŠ è½½å’ŒåŠ¨æ€é€‰æ‹©
â”œâ”€â”€ quic/                # QUIC ç›¸å…³æ¨¡å—
â”‚   â”œâ”€â”€ mod.rs          # æ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ config.rs       # QUIC æœåŠ¡å™¨é…ç½®
â”‚   â””â”€â”€ client.rs       # QUIC å®¢æˆ·ç«¯è¿æ¥
â”œâ”€â”€ upstream/            # ä¸Šæ¸¸è¿æ¥æ¨¡å—
â”‚   â”œâ”€â”€ mod.rs          # æ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ http.rs         # HTTP å®¢æˆ·ç«¯å’Œè½¬å‘
â”‚   â””â”€â”€ quic.rs         # QUIC æµè½¬å‘
â”œâ”€â”€ proxy/               # ä»£ç†è½¬å‘æ¨¡å—
â”‚   â”œâ”€â”€ mod.rs          # æ¨¡å—å¯¼å‡º
â”‚   â””â”€â”€ http.rs         # HTTP è¯·æ±‚å¤„ç†å’Œ SNI é‡å†™
â”œâ”€â”€ readers/             # åè®®æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ mod.rs          # æ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ doh.rs          # DoH æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ dot.rs          # DoT æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ doq.rs          # DoQ æœåŠ¡å™¨å®ç°
â”‚   â””â”€â”€ doh3.rs         # DoH3 æœåŠ¡å™¨å®ç°
â””â”€â”€ rewriters/          # SNI é‡å†™å™¨å®ç°
    â”œâ”€â”€ mod.rs          # æ¨¡å—å¯¼å‡º
    â””â”€â”€ base.rs         # åŸºç¡€å‰ç¼€æå–é‡å†™å™¨

tests/                   # æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ config.rs           # é…ç½®æ¨¡å—æµ‹è¯•
â”œâ”€â”€ rewriters_base.rs   # é‡å†™å™¨æµ‹è¯•
â”œâ”€â”€ rewrite.rs          # å·¥å‚å‡½æ•°æµ‹è¯•
â”œâ”€â”€ tls_utils.rs        # TLS å·¥å…·æµ‹è¯•
â”œâ”€â”€ app.rs              # åº”ç”¨æµ‹è¯•
â”œâ”€â”€ quic.rs             # QUIC æ¨¡å—æµ‹è¯•
â”œâ”€â”€ upstream.rs         # ä¸Šæ¸¸æ¨¡å—æµ‹è¯•
â””â”€â”€ proxy.rs            # ä»£ç†æ¨¡å—æµ‹è¯•
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### `sni.rs` - SNI é‡å†™å™¨æ¥å£

å®šä¹‰äº† `SniRewriter` traitï¼Œæ‰€æœ‰é‡å†™å™¨å¿…é¡»å®ç°ï¼š

```rust
pub trait SniRewriter {
    async fn rewrite(&self, sni: &str) -> Option<RewriteResult>;
}
```

#### `rewriters/base.rs` - åŸºç¡€é‡å†™å™¨

å®ç°äº†å‰ç¼€æå–å’Œé‡å†™é€»è¾‘ï¼š

- æ”¯æŒå¤šä¸ªåŸºå‡†åŸŸå
- å‰ç¼€æå–ç®—æ³•
- ç›®æ ‡ä¸»æœºåæ„å»º
- SNI æ˜ å°„ç¼“å­˜

#### `quic/` - QUIC æ¨¡å—

QUIC ç›¸å…³çš„é…ç½®å’Œè¿æ¥ç®¡ç†ï¼š

- `config.rs` - ç»Ÿä¸€çš„ QUIC æœåŠ¡å™¨ç«¯ç‚¹åˆ›å»º
- `client.rs` - QUIC å®¢æˆ·ç«¯è¿æ¥ç®¡ç†

#### `upstream/` - ä¸Šæ¸¸è¿æ¥æ¨¡å—

ä¸Šæ¸¸æœåŠ¡å™¨çš„è¿æ¥å’Œè½¬å‘é€»è¾‘ï¼š

- `http.rs` - HTTP å®¢æˆ·ç«¯åˆ›å»ºå’Œè¯·æ±‚è½¬å‘ï¼ˆå…±äº«å®¢æˆ·ç«¯å®ä¾‹ï¼‰
- `quic.rs` - QUIC æµè½¬å‘ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ï¼‰

#### `proxy/` - ä»£ç†è½¬å‘æ¨¡å—

ä»£ç†è½¬å‘é€»è¾‘çš„æŠ½è±¡ï¼š

- `http.rs` - HTTP è¯·æ±‚å¤„ç†ã€SNI é‡å†™å’Œä¸Šæ¸¸è½¬å‘

#### `readers/` - åè®®æœåŠ¡å™¨

æ¯ä¸ªåè®®ç‹¬ç«‹çš„æœåŠ¡å™¨å®ç°ï¼ˆå·²ç®€åŒ–ï¼Œä½¿ç”¨å…±äº«æ¨¡å—ï¼‰ï¼š

- ç›‘å¬æŒ‡å®šç«¯å£
- ä½¿ç”¨ `proxy` æ¨¡å—å¤„ç†è¯·æ±‚
- ä½¿ç”¨ `upstream` æ¨¡å—è½¬å‘åˆ°ä¸Šæ¸¸

#### `tls_utils.rs` - TLS è¯ä¹¦ç®¡ç†

- åŠ¨æ€è¯ä¹¦åŠ è½½
- åŸºäº SNI çš„è¯ä¹¦é€‰æ‹©
- è¯ä¹¦ç¼“å­˜æœºåˆ¶
- é”ä¸­æ¯’æ£€æµ‹

#### `app.rs` - åº”ç”¨ç®¡ç†

- é…ç½®åŠ è½½å’ŒéªŒè¯
- é‡å†™å™¨åˆ›å»º
- å„åè®®æœåŠ¡å™¨å¯åŠ¨ï¼ˆå¹¶è¡Œï¼‰
- ç”Ÿå‘½å‘¨æœŸç®¡ç†

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶æ ¼å¼

å¤åˆ¶ `config.toml.example` ä¸º `config.toml` å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š

```toml
[rewrite]
# åŸºå‡†åŸŸååˆ—è¡¨ï¼Œæ”¯æŒå¤šä¸ªåŸŸå
# é‡å†™å™¨ä¼šä»åŒ¹é…è¿™äº›åŸºå‡†åŸŸåçš„ hostname ä¸­æå–å‰ç¼€
base_domains = ["example.com", "example.org"]
# ç›®æ ‡åŸŸååç¼€ï¼Œæå–çš„å‰ç¼€ä¼šä¸æ­¤åç¼€ç»„åˆå½¢æˆç›®æ ‡ä¸»æœºå
target_suffix = ".example.cn"

[servers]
# DNS over TLS (DoT) - TCP 853
[servers.dot]
enabled = true
bind_address = "0.0.0.0"
port = 853

# DNS over HTTPS (DoH) - TCP 443
[servers.doh]
enabled = true
bind_address = "0.0.0.0"
port = 443

# DNS over QUIC (DoQ) - UDP 853
[servers.doq]
enabled = true
bind_address = "0.0.0.0"
port = 853

# DNS over HTTP/3 (DoH3) - UDP 443
[servers.doh3]
enabled = false
bind_address = "0.0.0.0"
port = 443

[upstream]
# é»˜è®¤ä¸Šæ¸¸æœåŠ¡å™¨
default = "8.8.8.8:853"
# åè®®ç‰¹å®šçš„ä¸Šæ¸¸æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼Œå›é€€åˆ° defaultï¼‰
dot = "8.8.8.8:853"
doh = "https://dns.google/dns-query"
doq = "8.8.8.8:853"
doh3 = "https://dns.google/dns-query"

[tls]
# é»˜è®¤è¯ä¹¦é…ç½®ï¼ˆå¯é€‰ï¼Œå½“æ²¡æœ‰æ‰¾åˆ°åŸŸåç‰¹å®šè¯ä¹¦æ—¶ä½¿ç”¨ï¼‰
[tls.default]
cert_file = "/path/to/default-cert.pem"
key_file = "/path/to/default-key.pem"
# ca_file = "/path/to/default-ca.pem"
require_client_cert = false

# ä¸ºæ¯ä¸ªåŸºå‡†åŸŸåé…ç½®ç‹¬ç«‹çš„è¯ä¹¦
[tls.certs.example.com]
cert_file = "/path/to/example-com-cert.pem"
key_file = "/path/to/example-com-key.pem"

[tls.certs.example.org]
cert_file = "/path/to/example-org-cert.pem"
key_file = "/path/to/example-org-key.pem"
```

### é…ç½®é¡¹è¯´æ˜

#### `[rewrite]` - é‡å†™é…ç½®

- **`base_domains`** (å¿…éœ€): åŸºå‡†åŸŸååˆ—è¡¨ï¼Œç”¨äºåŒ¹é…å’Œæå–å‰ç¼€
- **`target_suffix`** (å¿…éœ€): ç›®æ ‡åŸŸååç¼€ï¼Œä¸æå–çš„å‰ç¼€ç»„åˆ

#### `[servers.*]` - æœåŠ¡å™¨é…ç½®

æ¯ä¸ªåè®®æœåŠ¡å™¨é…ç½®ï¼š

- **`enabled`**: æ˜¯å¦å¯ç”¨è¯¥åè®®æœåŠ¡å™¨
- **`bind_address`**: ç»‘å®šåœ°å€ï¼ˆå¦‚ "0.0.0.0" æˆ– "127.0.0.1"ï¼‰
- **`port`**: ç›‘å¬ç«¯å£

#### `[upstream]` - ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®

- **`default`**: é»˜è®¤ä¸Šæ¸¸æœåŠ¡å™¨ï¼ˆæ‰€æœ‰åè®®çš„å›é€€é€‰é¡¹ï¼‰
- **`dot`**, **`doh`**, **`doq`**, **`doh3`**: åè®®ç‰¹å®šçš„ä¸Šæ¸¸æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰

#### `[tls]` - TLS è¯ä¹¦é…ç½®

- **`[tls.default]`**: é»˜è®¤è¯ä¹¦é…ç½®ï¼ˆå¯é€‰ï¼‰
- **`[tls.certs.<domain>]`**: åŸŸåç‰¹å®šçš„è¯ä¹¦é…ç½®
  - **`cert_file`**: è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼ˆPEM æ ¼å¼ï¼‰
  - **`key_file`**: ç§é’¥æ–‡ä»¶è·¯å¾„ï¼ˆPEM æ ¼å¼ï¼‰
  - **`ca_file`**: CA è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
  - **`require_client_cert`**: æ˜¯å¦è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆé»˜è®¤ï¼šfalseï¼‰

## ä½¿ç”¨æ–¹æ³•

### ç¼–è¯‘

```bash
# å¼€å‘æ¨¡å¼
cargo build

# å‘å¸ƒæ¨¡å¼
cargo build --release
```

### è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆä» config.toml åŠ è½½ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
cargo run

# æˆ–ç›´æ¥è¿è¡Œç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
./target/release/dns-proxy
```

### æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test

# è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶
cargo test --test config
cargo test --test quic
cargo test --test upstream
cargo test --test proxy

# è¿è¡Œå•å…ƒæµ‹è¯•
cargo test --lib

# æ˜¾ç¤ºæµ‹è¯•è¾“å‡º
cargo test -- --nocapture
```

## æ‰©å±•æ€§

### æ·»åŠ æ–°çš„åè®®æ”¯æŒ

è¦æ·»åŠ æ–°çš„åè®®æ”¯æŒï¼Œè¯·å‚è€ƒ `src/readers/README.md`ï¼š

1. åœ¨ `readers/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„åè®®æ–‡ä»¶ï¼ˆå¦‚ `new_protocol.rs`ï¼‰
2. å®ç°æœåŠ¡å™¨ç»“æ„ä½“å’Œ `start()` æ–¹æ³•
3. åœ¨ `readers/mod.rs` ä¸­å¯¼å‡º
4. åœ¨ `app.rs` ä¸­æ·»åŠ å¯åŠ¨é€»è¾‘

### æ·»åŠ æ–°çš„é‡å†™å™¨

è¦æ·»åŠ è‡ªå®šä¹‰çš„ SNI é‡å†™é€»è¾‘ï¼Œè¯·å‚è€ƒ `src/rewriters/README.md`ï¼š

1. åœ¨ `rewriters/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„é‡å†™å™¨æ–‡ä»¶
2. å®ç° `SniRewriter` trait
3. åœ¨ `rewriters/mod.rs` ä¸­å¯¼å‡º
4. åœ¨ `rewrite.rs` ä¸­æ›´æ–°å·¥å‚å‡½æ•°ï¼ˆå¯é€‰ï¼‰

## æ€§èƒ½ä¼˜åŒ–

é¡¹ç›®é‡‡ç”¨äº†å¤šé¡¹æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼š

1. **å…±äº«é…ç½®** - ä½¿ç”¨ `Arc<AppConfig>` é¿å…é…ç½®å¤åˆ¶
2. **è¯ä¹¦ç¼“å­˜** - TLS è¯ä¹¦åŠ è½½åç¼“å­˜ï¼Œé¿å…é‡å¤æ–‡ä»¶ I/O
3. **SNI æ˜ å°„ç¼“å­˜** - é‡å†™ç»“æœç¼“å­˜ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦
4. **å¼‚æ­¥ I/O** - åŸºäº Tokio çš„å¼‚æ­¥è¿è¡Œæ—¶ï¼Œæ”¯æŒé«˜å¹¶å‘
5. **é›¶æ‹·è´ä¼˜åŒ–** - å‡å°‘ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ï¼š
   - ä½¿ç”¨ `Bytes` å’Œåˆ‡ç‰‡å¼•ç”¨è€Œé `Vec<u8>` å¤åˆ¶
   - å¤ç”¨ç¼“å†²åŒºï¼ˆå¦‚ DoT reader ä¸­å¤ç”¨ bufferï¼‰
   - ç›´æ¥ä½¿ç”¨ `to_bytes()` è€Œéé¢å¤–å¤åˆ¶
   - ä½¿ç”¨åˆ‡ç‰‡å¼•ç”¨ä¼ é€’æ•°æ®ï¼ˆ`&[u8]` è€Œé `Vec<u8>`ï¼‰
6. **å…±äº«å®¢æˆ·ç«¯å®ä¾‹** - HTTP å®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨å®ä¾‹é—´å…±äº«ï¼Œé¿å…é‡å¤åˆ›å»º
7. **æ¨¡å—åŒ–è®¾è®¡** - æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œå‡å°‘ä»£ç é‡å¤ï¼Œæé«˜å¯ç»´æŠ¤æ€§

## å¾…å®Œå–„åŠŸèƒ½

- [ ] DoT åè®®ä¸­å®Œæ•´çš„ SNI æå–å’Œé‡å†™ï¼ˆå½“å‰ä¸ºç®€åŒ–å®ç°ï¼‰
- [ ] DoQ åè®®ä¸­ QUIC è¿æ¥çš„ SNI æå–å’Œé‡å†™
- [ ] TLS è¯ä¹¦åŠ¨æ€åŠ è½½å’Œçƒ­é‡è½½
- [ ] æ›´å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] é…ç½®çƒ­é‡è½½
- [ ] HTTP/3 å®¢æˆ·ç«¯å®ç°ï¼ˆå½“å‰ä½¿ç”¨ HTTP/1.1 å®¢æˆ·ç«¯ä½œä¸ºä¸Šæ¸¸ï¼‰

## ä¾èµ–

### æ ¸å¿ƒä¾èµ–

- `tokio` - å¼‚æ­¥è¿è¡Œæ—¶
- `rustls` / `tokio-rustls` - TLS æ”¯æŒ
- `quinn` (0.11) - QUIC åè®®æ”¯æŒ
- `h3` (0.0.8) / `h3-quinn` (0.0.10) - HTTP/3 æ”¯æŒ
- `hyper` / `hyper-util` - HTTP æ”¯æŒ
- `rustls-native-certs` - ç³»ç»Ÿæ ¹è¯ä¹¦æ”¯æŒ

### å·¥å…·ä¾èµ–

- `serde` / `toml` - é…ç½®è§£æ
- `tracing` / `tracing-subscriber` - æ—¥å¿—è®°å½•
- `anyhow` - é”™è¯¯å¤„ç†
- `bytes` - å­—èŠ‚å¤„ç†ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ï¼‰
- `http-body-util` - HTTP body å·¥å…·
- `async-trait` - å¼‚æ­¥ trait æ”¯æŒ
- `futures` - Future å·¥å…·

### å¼€å‘ä¾èµ–

- `tempfile` - ä¸´æ—¶æ–‡ä»¶ï¼ˆæµ‹è¯•ç”¨ï¼‰

## è®¸å¯è¯

AGPL3
